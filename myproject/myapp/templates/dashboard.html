{% extends 'base.html' %}
{% block title %}‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢{% endblock %}
{% block content %}

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-30px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @keyframes slideInRight {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }

  .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
  .slide-in-left { animation: slideInLeft 0.6s ease-out forwards; }
  .slide-in-right { animation: slideInRight 0.6s ease-out forwards; }
  .scale-in { animation: scaleIn 0.5s ease-out forwards; }

  .card-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card-hover:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  }

  .gradient-bg {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .gradient-text {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .glass-effect {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .shimmer-loading {
    background: linear-gradient(90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
    background-size: 2000px 100%;
    animation: shimmer 2s infinite;
  }

  .kpi-card {
    position: relative;
    overflow: hidden;
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 3s ease-in-out infinite;
  }

  .chart-container {
    position: relative;
    transition: all 0.3s ease;
  }

  .chart-container:hover {
    transform: scale(1.02);
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
  }

  .stagger-1 { animation-delay: 0.1s; }
  .stagger-2 { animation-delay: 0.2s; }
  .stagger-3 { animation-delay: 0.3s; }
  .stagger-4 { animation-delay: 0.4s; }
  .stagger-5 { animation-delay: 0.5s; }
  .stagger-6 { animation-delay: 0.6s; }
  /* --- Additions for prettier Top10 + KPIs --- */
  .chip {
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.25rem .65rem; border-radius:9999px;
    background: linear-gradient(135deg, #ede9fe 0%, #ffe4f1 100%);
    color:#6b21a8; font-weight:600; font-size:.85rem;
  }
  .rank-circle{
    width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;
    border-radius:9999px;color:#fff;font-weight:700;font-size:.8rem;flex:none;
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    box-shadow: 0 6px 14px rgba(118,75,162,.25);
  }
  .rank-1{ background: linear-gradient(135deg,#fcd34d,#f59e0b);}
  .rank-2{ background: linear-gradient(135deg,#d1d5db,#9ca3af);}
  .rank-3{ background: linear-gradient(135deg,#fbbf24,#b45309);}
  .menu-item{
    transition:transform .2s ease, box-shadow .2s ease;
  }
  .menu-item:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(102,126,234,.08);
    background:linear-gradient(90deg,#faf5ff 0%,#fff 100%);
  }

  /* KPI wrappers with gradient ring */
  .kpi-ring{ padding:2px; border-radius:1.5rem;
    background:linear-gradient(135deg,#e9d5ff 0%,#ffd6e7 100%);
  }
  .kpi-card-compact{
    border-radius:1.4rem; min-height:150px;
    display:grid; grid-template-columns:auto 1fr; align-items:center; gap:14px;
  }
  .kpi-icon{
    width:46px;height:46px;border-radius:9999px;
    display:flex;align-items:center;justify-content:center;flex:none;
    background:rgba(102,126,234,.12); backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.6);
  }
  .kpi-label{
    letter-spacing:.1em; font-size:.75rem; color:#6b7280; text-transform:uppercase;
  }
  .kpi-value{
    font-size:2.25rem; line-height:1.1; font-weight:800;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .kpi-sub{ font-size:.8rem; color:#6b7280; display:flex; align-items:center; gap:.4rem}
  .soft-divider{ height:1px; background:linear-gradient(90deg,transparent,#ede9fe,transparent); margin:.35rem 0 .1rem }
</style>


<!-- Background gradient overlay -->
<div class="fixed inset-0 bg-gradient-to-br from-purple-50 via-white to-pink-50 -z-10"></div>

<!-- Header with gradient -->
<div class="flex items-center justify-between mb-8 fade-in-up">
  <h1 class="text-4xl font-bold gradient-text">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h1>
  <form method="get" class="flex items-end gap-3 glass-effect px-6 py-4 rounded-2xl shadow-lg">
    <div class="flex flex-col">
      {{ filter.start_date.label_tag }}
      <div class="mt-1">{{ filter.start_date }}</div>
    </div>
    <div class="flex flex-col">
      {{ filter.end_date.label_tag }}
      <div class="mt-1">{{ filter.end_date }}</div>
    </div>
    <div class="flex flex-col">
      {{ filter.channel.label_tag }}
      <div class="mt-1">{{ filter.channel }}</div>
    </div>
    <button class="px-6 py-2.5 rounded-xl gradient-bg text-white font-medium hover:shadow-lg transform hover:scale-105 transition-all duration-300">
      <span class="flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
        </svg>
        ‡∏Å‡∏£‡∏≠‡∏á
      </span>
    </button>
  </form>
</div>

<!-- Top row: Top menu + KPI cards (PRETTIER) -->
<div class="grid lg:grid-cols-12 gap-6 mb-8">

  <!-- Top 10 Menu -->
  <div class="glass-effect p-6 rounded-3xl shadow-xl card-hover lg:col-span-3 slide-in-left stagger-1">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-bold text-lg gradient-text">‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h2>
      <span class="text-xs px-2 py-1 rounded-full gradient-bg text-white">Top 10</span>
    </div>

    <ul class="space-y-1.5">
      {% for r in top %}
      <li class="menu-item flex justify-between items-center px-2 py-2 rounded-xl">
        <div class="flex items-center gap-3 min-w-0">
          <span class="rank-circle
            {% if forloop.counter == 1 %}rank-1{% elif forloop.counter == 2 %}rank-2{% elif forloop.counter == 3 %}rank-3{% endif %}">
            {{ forloop.counter }}
          </span>
          <span class="text-sm font-medium truncate" title="{{ r.menu_label }}">{{ r.menu_label }}</span>
        </div>
        <span class="chip">{{ r.total_qty }}</span>
      </li>
      {% empty %}
      <li class="text-gray-400 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
      {% endfor %}
    </ul>
  </div>

  <!-- KPI Cards -->
  <div class="lg:col-span-9 grid sm:grid-cols-3 gap-6">

    <!-- Orders -->
    <div class="kpi-ring">
      <div class="kpi-card kpi-card-compact glass-effect p-5 shadow-xl card-hover text-left scale-in stagger-2">
        <div class="kpi-icon">
          <!-- package icon -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M3 7l9 5 9-5M3 7l9-5 9 5M3 7v10l9 5 9-5V7" stroke="currentColor" stroke-width="1.6" />
          </svg>
        </div>
        <div>
          <div class="kpi-label">Total Orders</div>
          <div class="kpi-value" id="kpiOrders">-</div>
          <div class="soft-divider"></div>
          <div class="kpi-sub">üì¶ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
      </div>
    </div>

    <!-- Revenue -->
    <div class="kpi-ring">
      <div class="kpi-card kpi-card-compact glass-effect p-5 shadow-xl card-hover text-left scale-in stagger-3">
        <div class="kpi-icon">
          <!-- coin flame -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 3s-2 3-2 5a4 4 0 0 0 8 0c0-2-2-5-2-5" stroke="currentColor" stroke-width="1.6" />
            <circle cx="12" cy="15" r="6" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <div>
          <div class="kpi-label">Total Revenue</div>
          <div class="kpi-value" id="kpiRevenue">-</div>
          <div class="soft-divider"></div>
          <div class="kpi-sub">üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
        </div>
      </div>
    </div>

    <!-- AOV -->
    <div class="kpi-ring">
      <div class="kpi-card kpi-card-compact glass-effect p-5 shadow-xl card-hover text-left scale-in stagger-4">
        <div class="kpi-icon">
          <!-- credit card -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.6"/>
            <path d="M3 10h18" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <div>
          <div class="kpi-label">Average Order Value</div>
          <div class="kpi-value" id="kpiAOV">-</div>
          <div class="soft-divider"></div>
          <div class="kpi-sub">üìä ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- Bottom row: Hourly charts -->
<div class="grid gap-6 mb-8">
  <div class="glass-effect p-6 rounded-3xl shadow-xl card-hover slide-in-left">
    <h2 class="font-bold text-lg gradient-text mb-4">‚è∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ & ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (24 ‡∏ä‡∏°.)</h2>
    <div class="chart-container">
      <canvas id="byHourCombo" height="160"></canvas>
    </div>
  </div>

<!-- Middle row: Daily charts + Channel donut -->
<div class="grid lg:grid-cols-12 gap-6 mb-8">
  <div class="glass-effect p-6 rounded-3xl shadow-xl card-hover lg:col-span-8 fade-in-up stagger-5">
    <h2 class="font-bold text-lg gradient-text mb-4">üìà ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
    <!-- ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏•‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
    <div class="chart-container mt-10">
      <canvas id="byDay" height="120"></canvas>
    </div>

    <h3 class="font-bold text-lg gradient-text mt-8 mb-4">üìä ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°</h3>
    <!-- ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏•‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
    <div class="chart-container mt-10">
      <canvas id="byDayCum" height="110"></canvas>
    </div>
  </div>

  <div class="glass-effect p-6 rounded-3xl shadow-xl card-hover lg:col-span-4 fade-in-up stagger-6">
    <h2 class="font-bold text-lg gradient-text mb-4">üéØ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</h2>
    <div id="channelEmpty" class="text-sm text-gray-400 hidden text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div>
    <div class="chart-container">
      <canvas id="byChannel" height="220"></canvas>
    </div>
  </div>
</div>

  <div class="glass-effect p-6 rounded-3xl shadow-xl card-hover slide-in-right">
    <h2 class="font-bold text-lg gradient-text mb-4">üíé ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (AOV)</h2>
    <div class="chart-container">
      <canvas id="aovHour" height="130"></canvas>
    </div>
  </div>
</div>

<!-- AI Summary Box -->
<div class="grid">
  <div class="glass-effect p-6 rounded-3xl shadow-xl card-hover fade-in-up">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-bold text-lg gradient-text">ü§ñ ‡∏™‡∏£‡∏∏‡∏õ & ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (AI)</h2>
      <span class="text-xs px-3 py-1 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 text-purple-700">
      </span>
    </div>
    <div id="aiBox" class="text-sm whitespace-pre-wrap min-h-[120px] p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl"></div>
    <div class="mt-4 flex flex-col items-center gap-3">
      <button id="refreshAI" class="px-6 py-3 rounded-xl gradient-bg text-white font-medium hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ
      </button>
      <span id="aiLoading" class="text-purple-600 hidden flex items-center gap-2">
        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
      </span>
    </div>
  </div>
</div>

<!-- Data JSON -->
{{ hour|json_script:"hour-data" }}
{{ day|json_script:"day-data" }}
{{ day_cum|json_script:"day-cum-data" }}
{{ channel|json_script:"channel-data" }}

<script>
  // ---------- Helpers ----------
  const nf = new Intl.NumberFormat('th-TH');
  const cf = new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 });
  const fmtHour = h => `${String(h).padStart(2,'0')}:00`;
  const fmtDate = s => {
    if (!s) return s;
    if (s.includes('T')) return s.split('T')[0];
    if (s.includes(' ')) return s.split(' ')[0];
    return s;
  };

  // Custom chart colors
  const chartColors = {
    primary: 'rgba(102, 126, 234, 0.8)',
    secondary: 'rgba(118, 75, 162, 0.8)',
    tertiary: 'rgba(237, 100, 166, 0.8)',
    primaryLight: 'rgba(102, 126, 234, 0.2)',
    secondaryLight: 'rgba(118, 75, 162, 0.2)',
    gradient: (ctx) => {
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
      gradient.addColorStop(1, 'rgba(118, 75, 162, 0.4)');
      return gradient;
    }
  };

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 0-23 ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì AOV
  function buildFull24HourSeries(data) {
    const mRev = new Map(data.map(x => [Number(x.hr), Number(x.rev)]));
    const mOrd = new Map(data.map(x => [Number(x.hr), Number(x.orders ?? 0)]));
    const hours  = Array.from({length: 24}, (_, h) => h);
    const labels = hours.map(fmtHour);
    const rev    = hours.map(h => mRev.get(h) || 0);
    const orders = hours.map(h => mOrd.get(h) || 0);
    const aov    = hours.map((_, i) => orders[i] ? rev[i] / orders[i] : 0);
    return { labels, rev, orders, aov };
  }

  // ---------- Data ----------
  const hourData   = JSON.parse(document.getElementById('hour-data').textContent   || '[]');
  const dayData    = JSON.parse(document.getElementById('day-data').textContent    || '[]');
  const dayCumData = JSON.parse(document.getElementById('day-cum-data').textContent|| '[]');
  const channelData= JSON.parse(document.getElementById('channel-data').textContent|| '[]');

  const H = buildFull24HourSeries(hourData);

  // ---------- KPI Cards with animation ----------
  const totalOrders  = H.orders.reduce((s,v) => s + (v||0), 0);
  const totalRevenue = dayData.reduce((s,x) => s + Number(x.rev||0), 0);
  const avgOrder     = totalOrders ? totalRevenue / totalOrders : 0;

  // Animate numbers
  function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      const current = Math.floor(progress * (end - start) + start);
      obj.textContent = obj.id === 'kpiOrders' ? nf.format(current) : cf.format(current);
      if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
  }

  setTimeout(() => {
    animateValue(document.getElementById('kpiOrders'), 0, totalOrders, 1500);
    animateValue(document.getElementById('kpiRevenue'), 0, totalRevenue, 1500);
    animateValue(document.getElementById('kpiAOV'), 0, avgOrder, 1500);
  }, 500);

  // ---------- Daily line chart ----------
  (() => {
    const el = document.getElementById('byDay');
    if (!el || typeof Chart === 'undefined') return;
    const ctx = el.getContext('2d');
    const labels = dayData.map(x => fmtDate(x.d));

    new Chart(el, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Revenue',
          data: dayData.map(x => x.rev),
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 8,
          borderColor: chartColors.primary,
          backgroundColor: chartColors.gradient(ctx),
          fill: true,
          borderWidth: 3,
          pointBackgroundColor: '#fff',
          pointBorderColor: chartColors.primary,
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        animation: { duration: 2000, easing: 'easeInOutQuart' },
        scales: {
          x: {
            ticks: { callback: (v, i) => labels[i] },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { callback: v => cf.format(v) },
            grid: { color: 'rgba(0,0,0,0.03)' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            callbacks: {
              title: items => items[0].label,
              label: c => `‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${cf.format(c.parsed.y)}`
            }
          }
        }
      }
    });
  })();

  // ---------- Daily cumulative chart ----------
  (() => {
    const el = document.getElementById('byDayCum');
    if (!el || typeof Chart === 'undefined') return;
    const ctx = el.getContext('2d');
    const labels = dayCumData.map(x => fmtDate(x.d));

    new Chart(el, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Cumulative',
          data: dayCumData.map(x => x.cum_rev),
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 8,
          borderColor: chartColors.secondary,
          backgroundColor: 'rgba(118, 75, 162, 0.1)',
          fill: true,
          borderWidth: 3,
          pointBackgroundColor: '#fff',
          pointBorderColor: chartColors.secondary,
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        animation: { duration: 2000, easing: 'easeInOutQuart' },
        scales: {
          x: {
            ticks: { callback: (v, i) => labels[i] },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { callback: v => cf.format(v) },
            grid: { color: 'rgba(0,0,0,0.03)' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            callbacks: {
              title: items => items[0].label,
              label: c => `‡∏™‡∏∞‡∏™‡∏°: ${cf.format(c.parsed.y)}`
            }
          }
        }
      }
    });
  })();

  // ---------- Channel donut chart ----------
  (() => {
    const el = document.getElementById('byChannel');
    const empty = document.getElementById('channelEmpty');
    if (!el || typeof Chart === 'undefined') return;

    if (!channelData.length) {
      empty.classList.remove('hidden');
      el.classList.add('hidden');
      return;
    }

    new Chart(el, {
      type: 'doughnut',
      data: {
        labels: channelData.map(x => x.channel),
        datasets: [{
          label: 'Revenue',
          data: channelData.map(x => x.rev),
          backgroundColor: [
            'rgba(102, 126, 234, 0.8)',
            'rgba(118, 75, 162, 0.8)',
            'rgba(237, 100, 166, 0.8)',
            'rgba(255, 195, 0, 0.8)',
            'rgba(46, 213, 115, 0.8)'
          ],
          borderWidth: 3,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        animation: { animateRotate: true, animateScale: true, duration: 2000 },
        plugins: {
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            callbacks: { label: c => `${c.label}: ${cf.format(c.parsed)}` }
          },
          legend: {
            position: 'bottom',
            labels: { padding: 20, font: { size: 12 } }
          }
        }
      }
    });
  })();

  // ---------- Hourly combo chart ----------
  (() => {
    const el = document.getElementById('byHourCombo');
    if (!el || typeof Chart === 'undefined') return;
    const ctx = el.getContext('2d');

    new Chart(el, {
      data: {
        labels: H.labels,
        datasets: [
          {
            type: 'bar',
            label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
            data: H.rev,
            yAxisID: 'y',
            backgroundColor: chartColors.gradient(ctx),
            borderRadius: 8,
            borderSkipped: false
          },
          {
            type: 'line',
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•',
            data: H.orders,
            yAxisID: 'y1',
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 6,
            borderColor: chartColors.tertiary,
            backgroundColor: 'transparent',
            borderWidth: 3,
            pointBackgroundColor: chartColors.tertiary
          }
        ]
      },
      options: {
        responsive: true,
        animation: { duration: 2000 },
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: {
            ticks: { autoSkip: false, maxRotation: 0 },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { callback: v => cf.format(v) },
            title: { display: true, text: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)' },
            grid: { color: 'rgba(0,0,0,0.03)' }
          },
          y1: {
            beginAtZero: true,
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: { callback: v => nf.format(v) },
            title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•' }
          }
        },
        plugins: {
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            callbacks: {
              title: (items) => items[0]?.label || '',
              label: (item) => item.datasetIndex === 0
                               ? `‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${cf.format(item.parsed.y)}`
                               : `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•: ${nf.format(item.parsed.y)}`,
              afterBody: (items) => {
                const i = items[0].dataIndex;
                const ord = H.orders[i] || 0;
                const rev = H.rev[i] || 0;
                const aov = ord ? rev / ord : 0;
                return ord ? [`AOV: ${cf.format(aov)}`] : [];
              }
            }
          },
          legend: {
            display: true,
            labels: { padding: 20 }
          }
        }
      }
    });
  })();

  // ---------- AOV hourly chart ----------
  (() => {
    const el = document.getElementById('aovHour');
    if (!el || typeof Chart === 'undefined') return;
    const ctx = el.getContext('2d');

    new Chart(el, {
      type: 'bar',
      data: {
        labels: H.labels,
        datasets: [{
          label: 'AOV (‡∏ö‡∏≤‡∏ó/‡∏ö‡∏¥‡∏•)',
          data: H.aov,
          backgroundColor: function(context) {
            const value = context.parsed.y;
            const alpha = value > 0 ? Math.min(value / Math.max(...H.aov), 1) : 0.2;
            return `rgba(102, 126, 234, ${0.3 + alpha * 0.7})`;
          },
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        animation: { duration: 2000 },
        scales: {
          x: {
            ticks: { autoSkip: false, maxRotation: 0 },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { callback: v => cf.format(v) },
            grid: { color: 'rgba(0,0,0,0.03)' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            callbacks: { label: c => `AOV: ${cf.format(c.parsed.y)}` }
          }
        }
      }
    });
  })();

  // ---------- AI summary ----------
  const aiBtn = document.getElementById('refreshAI');
  const aiBox = document.getElementById('aiBox');
  const aiLoading = document.getElementById('aiLoading');

  const cacheKey = 'ai_summary:' + location.search;
  const cached = sessionStorage.getItem(cacheKey);
  if (cached) {
    aiBox.textContent = cached;
    aiBox.classList.add('fade-in-up');
  }

  let inFlight = false;
  async function fetchSummary() {
    if (inFlight) return;
    inFlight = true;
    try {
      aiBtn.disabled = true;
      aiBtn.classList.add('opacity-60','cursor-not-allowed');
      aiLoading.classList.remove('hidden');
      aiBox.classList.add('shimmer-loading');
      aiBox.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

      const params = new URLSearchParams(window.location.search);
      const r = await fetch('/api/summary?' + params.toString(), {
        method: 'GET',
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });

      if (r.redirected || r.status === 401) {
        aiBox.textContent = '‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà';
        aiBox.classList.remove('shimmer-loading');
        return;
      }

      const ct = (r.headers.get('content-type') || '').toLowerCase();
      const data = ct.includes('application/json') ? await r.json() : { error: '‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON' };
      const text = data.summary || data.error || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ';

      aiBox.classList.remove('shimmer-loading');
      aiBox.textContent = text;
      aiBox.classList.add('fade-in-up');
      sessionStorage.setItem(cacheKey, text);
    } catch (e) {
      aiBox.classList.remove('shimmer-loading');
      aiBox.textContent = '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e?.message || e);
    } finally {
      aiBtn.disabled = false;
      aiBtn.classList.remove('opacity-60','cursor-not-allowed');
      aiLoading.classList.add('hidden');
      inFlight = false;
    }
  }
  aiBtn.addEventListener('click', fetchSummary);
</script>
{% endblock %}
